<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simple Camera Access — Capture Photo</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#94a3b8;--accent:#10b981}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0;background:linear-gradient(180deg,#0b1220 0%, #071026 100%);color:#e6eef8;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:100%;max-width:920px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:18px;box-shadow:0 8px 30px rgba(2,6,23,0.6);}
    h1{margin:0 0 8px;font-size:18px}
    p.lead{margin:0 0 16px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
    .controls{display:flex;flex-direction:column;gap:10px}
    label{font-size:13px;color:var(--muted)}
    select,input[type=range]{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .btn-row{display:flex;gap:8px}
    button{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;background:var(--accent);color:#04221a;font-weight:600}
    button.ghost{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.04)}
    .preview{display:flex;flex-direction:column;align-items:center;gap:8px}
    video{width:100%;height:100%;background:#000;border-radius:8px;max-height:480px;object-fit:cover}
    canvas{display:none}
    .snapshot{width:100%;border-radius:8px;border:1px solid rgba(255,255,255,0.02);max-height:240px;object-fit:contain;background:#000}
    .meta{font-size:13px;color:var(--muted)}
    .note{font-size:12px;color:var(--muted);margin-top:8px}
    @media (max-width:900px){.grid{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <div class="card">
    <h1>Simple Camera Access — Capture Photo</h1>
    <p class="lead">A minimal demo that shows camera preview, lets you capture a photo, switch cameras, and download the snapshot.</p>

    <div class="grid">
      <section>
        <div class="preview">
          <video id="video" playsinline autoplay muted></video>
          <canvas id="canvas"></canvas>
          <img id="snapshot" class="snapshot" alt="snapshot preview" />
          <div class="meta" id="status">Status: <span id="statusText">idle</span></div>
        </div>
      </section>

      <aside>
        <div class="controls">
          <div>
            <label for="deviceSelect">Camera</label>
            <select id="deviceSelect"></select>
          </div>

          <div>
            <label for="facingMode">Facing mode (hint)</label>
            <select id="facingMode">
              <option value="user">Front (user)</option>
              <option value="environment" selected>Back (environment)</option>
            </select>
          </div>

          <div>
            <label for="resolution">Resolution (height) — preview constraint</label>
            <input id="resolution" type="range" min="240" max="1080" step="120" value="720">
          </div>

          <div class="btn-row">
            <button id="startBtn">Start Camera</button>
            <button id="stopBtn" class="ghost">Stop</button>
          </div>

          <div class="btn-row">
            <button id="captureBtn">Capture Photo</button>
            <button id="downloadBtn" class="ghost" disabled>Download</button>
          </div>

          <div class="note">Note: For privacy this works only on secure contexts (https or localhost). Allow camera permissions when prompted.</div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // Elements
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const snapshotImg = document.getElementById('snapshot');
    const deviceSelect = document.getElementById('deviceSelect');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const captureBtn = document.getElementById('captureBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const statusText = document.getElementById('statusText');
    const facingModeSelect = document.getElementById('facingMode');
    const resolutionRange = document.getElementById('resolution');

    let currentStream = null;

    function setStatus(msg){ statusText.textContent = msg; }

    // Get camera devices and populate select
    async function populateDevices(){
      try{
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoInputs = devices.filter(d => d.kind === 'videoinput');
        deviceSelect.innerHTML = '';
        videoInputs.forEach((d, i) => {
          const option = document.createElement('option');
          option.value = d.deviceId;
          option.text = d.label || `Camera ${i+1}`;
          deviceSelect.appendChild(option);
        });
        if(videoInputs.length === 0){
          const opt = document.createElement('option'); opt.text = 'No camera found'; opt.disabled = true; deviceSelect.appendChild(opt);
        }
      }catch(err){
        console.error('Error enumerating devices', err);
        setStatus('cannot list devices');
      }
    }

    // Start camera with constraints
    async function startCamera(){
      stopCamera();
      const selectedDeviceId = deviceSelect.value || undefined;
      const facingMode = facingModeSelect.value || undefined;
      const height = parseInt(resolutionRange.value, 10) || 720;

      const constraints = {
        audio: false,
        video: {
          height: { ideal: height },
          width: { ideal: Math.round((height * 16) / 9) },
          deviceId: selectedDeviceId ? { exact: selectedDeviceId } : undefined,
          facingMode: selectedDeviceId ? undefined : { ideal: facingMode }
        }
      };

      try{
        setStatus('starting…');
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = currentStream;
        await video.play();
        setStatus('streaming');
        downloadBtn.disabled = true;
        // refresh list since device labels may appear only after permission
        await populateDevices();
      }catch(err){
        console.error('getUserMedia error', err);
        setStatus('permission denied / unavailable');
        alert('Could not access camera: ' + (err.message || err.name));
      }
    }

    function stopCamera(){
      if(currentStream){
        currentStream.getTracks().forEach(t => t.stop());
        currentStream = null;
        video.srcObject = null;
        setStatus('stopped');
      }
    }

    // Capture current video frame to canvas and show preview
    function capturePhoto(){
      if(!currentStream){ alert('Camera not started'); return; }
      const track = currentStream.getVideoTracks()[0];
      const settings = track.getSettings();
      const w = settings.width || video.videoWidth || 1280;
      const h = settings.height || video.videoHeight || 720;
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, w, h);
      const dataUrl = canvas.toDataURL('image/png');
      snapshotImg.src = dataUrl;
      snapshotImg.style.display = 'block';
      downloadBtn.disabled = false;
      setStatus('captured');
    }

    function downloadSnapshot(){
      if(!snapshotImg.src) return;
      const a = document.createElement('a');
      a.href = snapshotImg.src;
      a.download = 'snapshot.png';
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    // Event listeners
    startBtn.addEventListener('click', startCamera);
    stopBtn.addEventListener('click', stopCamera);
    captureBtn.addEventListener('click', capturePhoto);
    downloadBtn.addEventListener('click', downloadSnapshot);

    deviceSelect.addEventListener('change', () => { startCamera(); });
    facingModeSelect.addEventListener('change', () => { startCamera(); });
    resolutionRange.addEventListener('change', () => { startCamera(); });

    // On load: populate devices. Some browsers require getUserMedia call before labels appear.
    (async function init(){
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        alert('Your browser does not support camera access via getUserMedia. Use a modern browser (Chrome, Edge, Firefox, Safari).');
        setStatus('unsupported');
        return;
      }
      await populateDevices();
      // Try to auto-start with default facing mode
      // We won't auto-start to avoid surprising the user — they'll press Start.
      setStatus('idle');
    })();

    // Clean up on page unload
    window.addEventListener('pagehide', stopCamera);
    window.addEventListener('beforeunload', stopCamera);
  </script>
</body>
</html>
